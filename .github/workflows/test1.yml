name: loop-run

on:
  workflow_dispatch: {}
  repository_dispatch:
    types: [rerun]

permissions:
  contents: write

concurrency:
  group: loop-run
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"   

      - name: Run loop (python -c, your code style)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          python -m pip install -q pandas requests
          start=$(date +%s)
          iter=0
          BRANCH="${GITHUB_REF_NAME:-${GITHUB_HEAD_REF:-main}}"
          git config --local user.name  "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          bbranch="$BRANCH" python -c $'from pathlib import Path\nimport subprocess\nimport xml.etree.ElementTree as ET\nimport os\nimport pandas as pd\nimport requests\n\np2 = Path("data/ind_arr3.txt")\np3 = Path("onlyL2.csv")\n\nwith open(p2, "r", encoding="utf-8") as file:\n    text = file.readlines()\ndf = pd.read_csv(p3)\n\nind = []\nID = []\n\nfor i in range(14582):\n    parts = text[i].split()\n    ind.append(int(parts[0]))\n    ID.append(int(parts[1]))\n\np = Path("data/v_data.csv")\nv = pd.read_csv(p)\n\nBRANCH = str(os.environ["bbranch"])\n\ndef save(msg: str):\n    v.to_csv(p, index=False)\n    subprocess.run(["git", "add", "--", str(p)], check=True)\n    subprocess.run(["git", "commit", "-m", msg], check=False)\n    subprocess.run(["git", "pull", "--rebase", "--autostash", "origin", BRANCH], check=False)\n    subprocess.run(["git", "push", "origin", f"HEAD:{BRANCH}"], check=False)\n    print("Updated!")\n\nperiod = 100\n\nfor i in range(4000,5000):\n    url = (\n        "http://openapi.seoul.go.kr:8088/"\n        "64525562596f736a36384e78567553/xml/TrafficInfo/1/1/%d/" % ID[i]\n    )\n\n    try:\n        r = requests.get(url, timeout=10)\n        root = ET.fromstring(r.content)\n        row = root.find("row")\n\n        if row is not None:\n            spd_text = row.findtext("prcs_spd")\n            if spd_text:\n                spd = float(spd_text)\n                v.loc[ind[i], "v"] = float(df._values[ind[i],0]) / spd\n\n    except Exception as e:\n        print(f"Error at index {i}: {e}")\n        continue\n\n    if i % period == 0:\n        save(f"update v_data.csv (up to idx={i})")'
      - name: Re-dispatch self
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_DISPATCH }}   # PAT with 'repo' scope
        run: |
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/dispatches" \
            -d '{"event_type":"rerun"}'
